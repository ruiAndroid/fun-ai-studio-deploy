#
# fun-ai-studio-deploy - production profile
# 说明：
# - 本文件作为生产环境基准配置（以后以此为准）
# - 请务必替换所有 CHANGE_ME_* 为强随机值，并在安全组/防火墙上收敛来源
#

server.port=7002
spring.application.name=funaistudiodeploy

spring.mvc.pathmatch.matching-strategy=ANT_PATH_MATCHER

# -----------------------------
# MySQL / JPA（建议生产启用：Deploy 控制面落库）
# -----------------------------
# 说明：
# - 对齐 API 服务（db_funaistudio）的风格；你也可以单独建 deploy 库
# - Deploy 会创建/使用表：
#   - fun_ai_deploy_runtime_node
#   - fun_ai_deploy_runtime_placement
#   - fun_ai_deploy_app_run（last-known，类似 fun_ai_workspace_run）
# 对齐 API 项目的 JDBC 参数；注意：Deploy 在 100 上运行时，这里的 host 应填写 API MySQL 所在机（91）的可达地址
spring.datasource.url=jdbc:mysql://172.21.138.91:3306/db_funaistudio?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=Ss123456!
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.jpa.open-in-view=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect

# Swagger UI（生产可按需关闭）
springdoc.swagger-ui.path=/swagger-ui
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.operationsSorter=method
springdoc.swagger-ui.enabled=true
spring.web.resources.add-mappings=true
springdoc.api-docs.enabled=true

logging.level.root=INFO

# -----------------------------
# 日志落盘（deploy 控制面）
# -----------------------------
# 目标文件（持续写入）
logging.file.name=/data/funai/logs/fun-ai-studio/fun-ai-studio-deploy/app.log
#
# 按天滚动 + 按大小分片（必须包含 %i；gzip 压缩）
# 生成示例：app.2026-01-20.0.log.gz
logging.logback.rollingpolicy.file-name-pattern=/data/funai/logs/fun-ai-studio/fun-ai-studio-deploy/app.%d{yyyy-MM-dd}.%i.log.gz
# 单文件最大大小（超过会在同一天内滚动到下一个 %i）
logging.logback.rollingpolicy.max-file-size=100MB
# 保留最近 30 天
logging.logback.rollingpolicy.max-history=30
# 总日志大小上限（超过会清理旧日志）
logging.logback.rollingpolicy.total-size-cap=5GB
# 启动时清理超期日志
logging.logback.rollingpolicy.clean-history-on-start=true

# -----------------------------
# Deploy Proxy Auth（API -> Deploy 内部调用鉴权）
# -----------------------------
# 生产建议开启：仅 API 服务器（或网关）应持有该密钥
deploy.proxy-auth.enabled=true
# 可选：只允许指定来源 IP（逗号分隔）；为空则不校验（你当前希望“稍微放开”可以留空）
deploy.proxy-auth.allowed-ips=
# 必填：API -> Deploy 共享密钥（Header：X-DEPLOY-SECRET）
# - 需要与 API 配置 deploy-proxy.shared-secret 保持一致
deploy.proxy-auth.shared-secret=a7c4e1d9f0b3c6a2e8d5f1c7b9a0d3e6f2a8c5d1e7b0a4c9d2f6a1e3b8c0d5f9

# -----------------------------
# Deploy Admin（内部运维接口鉴权）
# -----------------------------
deploy.admin.enabled=true
# 可选：只允许指定来源 IP 访问 /admin/**（逗号分隔）；为空则不校验
deploy.admin.allowed-ips=
# 必填：运维接口 Token（Header：X-Admin-Token），生产请替换为强随机值
deploy.admin.token=4f3d8a72e19d7c0b6c2a7e4e8c3f1b2d9a4c0f6b1d8e7a2c3b9f0a6d5c1e7b8a3d2f9c0e1b7a6c4d8e2f0a9b1c3d5e7f8a0b2c4d6e8f0a1b3c5d7e9f1a3b5c7d9e1f3a5b7c9d1e3f5a7b9c1d3e5f7a9b1c3d5e7f9

# -----------------------------
# Runtime Node Registry（runtime 节点心跳注册）
# -----------------------------
deploy.runtime-node-registry.enabled=true
# 可选：只允许 runtime 节点来源 IP 访问 /internal/runtime-nodes/heartbeat（逗号分隔）；为空则不校验
deploy.runtime-node-registry.allowed-ips=
# 必填：节点心跳 Token（Header：X-RT-Node-Token），生产请替换为强随机值
deploy.runtime-node-registry.shared-secret=4c1d7e9a2b0f6d3c8a5e1f0b9d7c3a2e6f8b4d1a0c9e7b5f3d2a8c6e1b0f9d7a
# 心跳超时阈值（秒）：超过视为不健康（选择策略会过滤）
deploy.runtime-node-registry.heartbeat-stale-seconds=60

# -----------------------------
# Runtime Node Registry / Placement 持久化（建议生产开启，避免 Deploy 重启丢数据）
# -----------------------------
# 说明：
# - 仅当 deploy.runtime.persistence.enabled=true 且 spring.datasource.url 配置存在时才会启用 DB 落库；
# - 若未配置 datasource，本服务会回退到 InMemory（不影响启动，但数据不持久化）。
deploy.runtime.persistence.enabled=true

# Deploy App Run（last-known，类似 fun_ai_workspace_run）
deploy.run.persistence.enabled=true

# Deploy Job Queue 落库（建议生产开启）
deploy.job.persistence.enabled=true

# 生产建议配置 MySQL（示例；按你实际数据库填写）
# 说明：
# - 你可以复用 API 的库（例如 db_funaistudio），也可以单独建 deploy 库；
# - 表名会按 fun_ai_* 风格创建：fun_ai_deploy_runtime_node / fun_ai_deploy_runtime_placement
# spring.datasource.url=jdbc:mysql://127.0.0.1:3306/db_funaistudio?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
# spring.datasource.username=CHANGE_ME_DB_USER
# spring.datasource.password=CHANGE_ME_DB_PASS
# spring.jpa.hibernate.ddl-auto=update
# spring.jpa.show-sql=false
# spring.jpa.open-in-view=false

# -----------------------------
# Runner Registry（Runner 在线状态：通过 claim/heartbeat/report 自动更新）
# -----------------------------
deploy.runner-registry.heartbeat-stale-seconds=90


